import React, { FC, memo, useMemo, useEffect, useContext, useState } from 'react';
import { CaretDownOutlined, CaretRightOutlined, CaretLeftOutlined } from '@ant-design/icons';
import { GlobalConfigProps } from '../GlobalConfig/interface';
import cs from '../common_utils/classNames';
import { globalCtx } from '../GlobalConfig';
import { CollapseItemProps } from './interfase';
import './style/item.module.less';
import useStateCallback from '../common_utils/hooks/useStateCallback';
import { ctx } from './index';

const CollapseItem: FC<CollapseItemProps> = (props: CollapseItemProps) => {
  const { children, className, header, disabled = false, listKey, extra } = props;

  const [contentDomHeight, setContentDomHeight] = useState(0);
  const [hasOpen, setHasOpen] = useStateCallback(false);

  const { prefixCls } = useContext(globalCtx) as GlobalConfigProps;

  const classNames = cs(prefixCls, className, 'concis-collapse-item');
  const { activeKeyList, setActiveKeyList, accordion, headerAlign, lazyLoad, toggleCallback } =
    useContext(ctx); // 父组件共享状态

  useEffect(() => {
    // 根据默认值展开或收起
    if (activeKeyList.indexOf(Number(listKey)) === -1) {
      setContentDomHeight(0);
    } else {
      (document.querySelector('.concis-collapse-item-content') as HTMLElement)?.scrollHeight &&
        setContentDomHeight(
          (document.querySelector('.concis-collapse-item-content') as HTMLElement)?.scrollHeight +
            30
        );
    }
  }, [activeKeyList]);

  const toggleContent = () => {
    if (disabled) return; // 禁用
    let newHeight = contentDomHeight;
    if (newHeight === 0) {
      // 展开
      if (lazyLoad && !hasOpen) {
        // 首次展开懒加载
        setHasOpen(true, (state: boolean) => {
          newHeight =
            (document.querySelector('.concis-collapse-item-content') as HTMLElement)?.scrollHeight +
            30;
          if (accordion) {
            // 手风琴，全部清除再加入
            setActiveKeyList([Number(listKey)]);
            toggleCallback && toggleCallback([Number(listKey)]);
          } else {
            setActiveKeyList((oldAList: Array<string | number>) => {
              toggleCallback && toggleCallback([...[...oldAList, Number(listKey)].sort()]);
              return [...[...oldAList, Number(listKey)].sort()];
            });
          }
          setContentDomHeight(newHeight);
        });
      } else {
        newHeight =
          (document.querySelector('.concis-collapse-item-content') as HTMLElement)?.scrollHeight +
          30;
        if (accordion) {
          // 手风琴，全部清除再加入
          setActiveKeyList([Number(listKey)]);
          toggleCallback && toggleCallback([Number(listKey)]);
        } else {
          setActiveKeyList((oldAList: Array<string | number>) => {
            toggleCallback && toggleCallback([...[...oldAList, Number(listKey)].sort()]);
            return [...[...oldAList, Number(listKey)].sort()];
          });
        }
        setContentDomHeight(newHeight);
      }
    } else {
      // 收起
      newHeight = 0;
      setActiveKeyList((oldAList: Array<string | number>) => {
        oldAList.splice(
          oldAList.findIndex(
            (item: number | string, i: number | string) => Number(i) + 1 === listKey
          ),
          1
        );
        return [...oldAList.sort()];
      });
      setContentDomHeight(newHeight);
    }
  };

  const headerHeight = useMemo(() => {
    // 展开高度
    return {
      maxHeight: `${contentDomHeight}px`,
    };
  }, [contentDomHeight]);
  const renderHeader = useMemo(() => {
    if (headerAlign === 'left') {
      return (
        <div
          className="concis-collapse-item-header"
          onClick={toggleContent}
          style={disabled ? { color: '#c9cdd4', cursor: 'not-allowed' } : {}}
        >
          <div className="left">
            <div className="header-icon">
              {headerHeight.maxHeight === '0px' ? <CaretRightOutlined /> : <CaretDownOutlined />}
            </div>
            <div className="header-text">{header}</div>
          </div>
          {extra && <div className="right">{extra}</div>}
        </div>
      );
    }
    if (headerAlign === 'right') {
      return (
        <div
          className="concis-collapse-item-header"
          onClick={toggleContent}
          style={disabled ? { color: '#c9cdd4', cursor: 'not-allowed' } : {}}
        >
          <div className="left">
            <div className="header-text">{header}</div>
          </div>
          <div className="right">
            {extra}
            <div className="header-icon">
              {headerHeight.maxHeight === '0px' ? <CaretLeftOutlined /> : <CaretDownOutlined />}
            </div>
          </div>
        </div>
      );
    }
    if (headerAlign === 'hide') {
      return (
        <div
          className="concis-collapse-item-header"
          onClick={toggleContent}
          style={disabled ? { color: '#c9cdd4', cursor: 'not-allowed' } : {}}
        >
          <div className="left">
            <div className="header-text">{header}</div>
          </div>
          <div className="right">{extra}</div>
        </div>
      );
    }
  }, [headerAlign, headerHeight, disabled]);
  return (
    <div className={classNames}>
      {renderHeader}
      <div className="concis-collapse-item-content" style={headerHeight}>
        {lazyLoad ? hasOpen && children : children}
      </div>
    </div>
  );
};

export default memo(CollapseItem);
